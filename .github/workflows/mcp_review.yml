name: MCP Code Review  # 工作流名称，显示在 Actions 页面

on:
  pull_request:        # 当 PR 打开、同步（push 到 PR 分支）或重新打开时触发
    types: [opened, synchronize, reopened]

permissions:
  contents: write      # 允许在仓库中写入内容（必要时更新文件或 artifact）
  pull-requests: write # 允许在 PR 上发表评论或更新（用于回写评审结果）

jobs:
  review:
    runs-on: ubuntu-latest  # 使用 GitHub 托管的 Ubuntu runner

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 拉取完整历史，保证可以基于 base.sha 做准确 diff/注释定位

      - name: Collect PR context
        run: |
          # 把改动的文件名压缩成一行并写入环境变量，避免多行导致的问题
          echo "FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tr '\n' ' ')" >> $GITHUB_ENV
          # 将完整 diff 写入文件，避免把长内容放到环境变量中导致溢出或换行问题
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff.txt
          echo "DIFF_FILE=diff.txt" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"  # 指定 Python 版本以保证脚本运行环境一致

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # 安装项目依赖。建议对网络不稳定或频繁运行的场景使用 actions/cache 缓存 pip 包以加速

      - name: Show installed packages
        run: pip freeze
        # 可选步骤，输出已安装包列表便于调试依赖问题；生产可移除或限制输出

      - name: Run MCP Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # 自动注入的 token，用于在 PR 上回写注释或创建 Check Run
          GITHUB_REPOSITORY: ${{ github.repository }} # 仓库标识（owner/repo）
        run: |
          # 调用项目内的评审脚本，向其传入改动文件列表、diff 文件路径、业务需求文件、PR 编号和 base commit
          python scripts/mcp_review.py \
            --files "${{ env.FILES }}" \
            --diff-file "${{ env.DIFF_FILE }}" \
            --req requirements.md \
            --pr ${{ github.event.pull_request.number }} \
            --base-sha ${{ github.event.pull_request.base.sha }}
     
